can_use_magic_advancement_window = {
	is_valid = {
		OR = {
			mage_potency > 0
			mage_education > 0
		}
	}
}

is_magic_advancement_window_open = {
	scope = character
	is_valid = {
		has_variable = window_magic_advancement_view
	}
}

toggle_magic_advancement_window = {
	scope = character
	effect = {
		if = {
			limit = {
				has_variable = window_magic_advancement_view
			}
			effect_close_magic_advancement_window = yes
		}
		else = {
			if = {
				limit = { NOT = { has_variable = none_perk_mask_0 } }
				init_perk_masks_effect = yes
			}
			effect_open_magic_advancement_window = yes
		}
	}
}

toggle_magic_xp_or_focus_xp = {
	scope = character
	is_valid = {
		NOT = { has_variable = magic_advancement_cooldown }
	}
	effect = {
		if = {
			limit = { has_character_modifier = magic_advancement_modifier }
			remove_character_modifier = magic_advancement_modifier
		}
		else = {
			add_character_modifier = magic_advancement_modifier
		}
		set_variable = {
			name = magic_advancement_cooldown
			value = yes
			days = 1825
		}
	}
}

perk_select = {
	# aka has_been_selected - yes this is kind of backwards with is_valid
	# but it makes more sense, is_valid is if a button is valid to click
	is_shown = {
		switch = {
			trigger = scope:perk
			flag:mage_perk = { has_perk_trigger = { PERK = mage_perk } }
			flag:time_mage_perk = { has_perk_trigger = { PERK = time_mage_perk } }
			flag:glimpse_the_future_perk = { has_perk_trigger = { PERK = glimpse_the_future_perk } }
			flag:financial_times_perk = { has_perk_trigger = { PERK = financial_times_perk } }
			flag:celerity_perk = { has_perk_trigger = { PERK = celerity_perk } }
			flag:mass_celerity_perk = { has_perk_trigger = { PERK = mass_celerity_perk } }
			flag:slowness_perk = { has_perk_trigger = { PERK = slowness_perk } }
			flag:mass_slowness_perk = { has_perk_trigger = { PERK = mass_slowness_perk } }
			flag:temporal_manipulation_perk = { has_perk_trigger = { PERK = temporal_manipulation_perk } }
			flag:master_of_time_perk = { has_perk_trigger = { PERK = master_of_time_perk } }
			flag:life_mage_perk = { has_perk_trigger = { PERK = life_mage_perk } }
			flag:inward_reflection_perk = { has_perk_trigger = { PERK = inward_reflection_perk } }
			flag:inward_perfection_perk = { has_perk_trigger = { PERK = inward_perfection_perk } }
			flag:heal_perk = { has_perk_trigger = { PERK = heal_perk } }
			flag:greater_heal_perk = { has_perk_trigger = { PERK = greater_heal_perk } }
			flag:battlefield_life_mage_perk = { has_perk_trigger = { PERK = battlefield_life_mage_perk } }
			flag:greater_battlefield_life_mage_perk = { has_perk_trigger = { PERK = greater_battlefield_life_mage_perk } }
			flag:purity_of_body_perk = { has_perk_trigger = { PERK = purity_of_body_perk } }
			flag:avatar_of_life_perk = { has_perk_trigger = { PERK = avatar_of_life_perk } }
			flag:elemental_mage_perk = { has_perk_trigger = { PERK = elemental_mage_perk } }
			flag:flame_aura_perk = { has_perk_trigger = { PERK = flame_aura_perk } }
			flag:flaming_weapons_perk = { has_perk_trigger = { PERK = flaming_weapons_perk } }
			flag:living_earthworks_perk = { has_perk_trigger = { PERK = living_earthworks_perk } }
			flag:golem_creation_perk = { has_perk_trigger = { PERK = golem_creation_perk } }
			flag:control_water_perk = { has_perk_trigger = { PERK = control_water_perk } }
			flag:drought_perk = { has_perk_trigger = { PERK = drought_perk } }
			flag:elemental_warrior_perk = { has_perk_trigger = { PERK = elemental_warrior_perk } }
			flag:lord_of_the_elements_perk = { has_perk_trigger = { PERK = lord_of_the_elements_perk } }
			flag:death_mage_perk = { has_perk_trigger = { PERK = death_mage_perk } }
			flag:inflict_illness_perk = { has_perk_trigger = { PERK = inflict_illness_perk } }
			flag:plague_lord_perk = { has_perk_trigger = { PERK = plague_lord_perk } }
			flag:aura_of_death_perk = { has_perk_trigger = { PERK = aura_of_death_perk } }
			flag:necromancy_perk = { has_perk_trigger = { PERK = necromancy_perk } }
			flag:drain_life_perk = { has_perk_trigger = { PERK = drain_life_perk } }
			flag:death_stare_perk = { has_perk_trigger = { PERK = death_stare_perk } }
			flag:blight_perk = { has_perk_trigger = { PERK = blight_perk } }
			flag:deacon_of_death_perk = { has_perk_trigger = { PERK = deacon_of_death_perk } }
			flag:biomancy_mage_perk = { has_perk_trigger = { PERK = biomancy_mage_perk } }
			flag:improve_trait_perk = { has_perk_trigger = { PERK = improve_trait_perk } }
			flag:perfect_trait_perk = { has_perk_trigger = { PERK = perfect_trait_perk } }
			flag:fertility_control_perk = { has_perk_trigger = { PERK = fertility_control_perk } }
			flag:impregnate_perk = { has_perk_trigger = { PERK = impregnate_perk } }
			flag:weaken_trait_perk = { has_perk_trigger = { PERK = weaken_trait_perk } }
			flag:criple_trait_perk = { has_perk_trigger = { PERK = criple_trait_perk } }
			flag:sculpter_of_flesh_perk = { has_perk_trigger = { PERK = sculpter_of_flesh_perk } }
			flag:architect_of_bloodlines_perk = { has_perk_trigger = { PERK = architect_of_bloodlines_perk } }
			flag:domination_mage_perk = { has_perk_trigger = { PERK = domination_mage_perk } }
			flag:entrance_perk = { has_perk_trigger = { PERK = entrance_perk } }
			flag:incite_lust_perk = { has_perk_trigger = { PERK = incite_lust_perk } }
			flag:incite_obedience_perk = { has_perk_trigger = { PERK = incite_obedience_perk } }
			flag:dominate_perk = { has_perk_trigger = { PERK = dominate_perk } }
			flag:beguiling_aura_perk = { has_perk_trigger = { PERK = beguiling_aura_perk } }
			flag:friendship_perk = { has_perk_trigger = { PERK = friendship_perk } }
			flag:enchanting_aura_perk = { has_perk_trigger = { PERK = enchanting_aura_perk } }
			flag:master_of_puppets_perk = { has_perk_trigger = { PERK = master_of_puppets_perk } }
			fallback = { always = no }
		}
	}

	is_valid = { # aka can_be_selected
		AND = {
			OR = {
				NOT = { is_mage_trigger = yes } # workaround to keep non-mages from throwing 62 errors per frame
				var:available_magic_perks > 0
			}
			has_character_modifier = magic_advancement_modifier
			switch = {
				trigger = scope:perk
				flag:mage_perk = { always = yes }
				flag:time_mage_perk = { has_perk_trigger = { PERK = mage_perk } }
				flag:glimpse_the_future_perk = { has_perk_trigger = { PERK = time_mage_perk } }
				flag:financial_times_perk = { has_perk_trigger = { PERK = time_mage_perk } }
				flag:celerity_perk = { has_perk_trigger = { PERK = financial_times_perk } }
				flag:mass_celerity_perk = { has_perk_trigger = { PERK = celerity_perk } }
				flag:slowness_perk = { has_perk_trigger = { PERK = glimpse_the_future_perk } }
				flag:mass_slowness_perk = { has_perk_trigger = { PERK = slowness_perk } }
				flag:temporal_manipulation_perk = { OR = { has_perk_trigger = { PERK = mass_slowness_perk } has_perk_trigger = { PERK = mass_celerity_perk } } }
				flag:master_of_time_perk = { has_perk_trigger = { PERK = temporal_manipulation_perk } }
				flag:life_mage_perk = { has_perk_trigger = { PERK = mage_perk } }
				flag:inward_reflection_perk = { has_perk_trigger = { PERK = life_mage_perk } }
				flag:inward_perfection_perk = { has_perk_trigger = { PERK = inward_reflection_perk } }
				flag:heal_perk = { has_perk_trigger = { PERK = life_mage_perk } }
				flag:greater_heal_perk = { has_perk_trigger = { PERK = heal_perk } }
				flag:battlefield_life_mage_perk = { has_perk_trigger = { PERK = life_mage_perk } }
				flag:greater_battlefield_life_mage_perk = { has_perk_trigger = { PERK = battlefield_life_mage_perk } }
				flag:purity_of_body_perk = { OR = { has_perk_trigger = { PERK = inward_perfection_perk } has_perk_trigger = { PERK = greater_heal_perk } has_perk_trigger = { PERK = greater_battlefield_life_mage_perk } } }
				flag:avatar_of_life_perk = { has_perk_trigger = { PERK = purity_of_body_perk } }
				flag:elemental_mage_perk = { has_perk_trigger = { PERK = mage_perk } }
				flag:flame_aura_perk = { always = yes }
				flag:flaming_weapons_perk = { always = yes }
				flag:living_earthworks_perk = { always = yes }
				flag:golem_creation_perk = { always = yes }
				flag:control_water_perk = { always = yes }
				flag:drought_perk = { always = yes }
				flag:elemental_warrior_perk = { always = yes }
				flag:lord_of_the_elements_perk = { always = yes }
				flag:death_mage_perk = { has_perk_trigger = { PERK = mage_perk } }
				flag:inflict_illness_perk = { has_perk_trigger = { PERK = necromancy_perk } }
				flag:plague_lord_perk = { has_perk_trigger = { PERK = inflict_illness_perk } }
				flag:aura_of_death_perk = { has_perk_trigger = { PERK = necromancy_perk } }
				flag:necromancy_perk = { has_perk_trigger = { PERK = death_mage_perk } }
				flag:drain_life_perk = { has_perk_trigger = { PERK = necromancy_perk } }
				flag:death_stare_perk = { has_perk_trigger = { PERK = drain_life_perk } }
				flag:blight_perk = { has_perk_trigger = { PERK = aura_of_death_perk } }
				flag:deacon_of_death_perk = { AND = { has_perk_trigger = { PERK = plague_lord_perk } has_perk_trigger = { PERK = death_stare_perk } has_perk_trigger = { PERK = blight_perk } } }
				flag:biomancy_mage_perk = { has_perk_trigger = { PERK = mage_perk } }
				flag:improve_trait_perk = { has_perk_trigger = { PERK = biomancy_mage_perk } }
				flag:perfect_trait_perk = { has_perk_trigger = { PERK = improve_trait_perk } }
				flag:fertility_control_perk = { has_perk_trigger = { PERK = biomancy_mage_perk } }
				flag:impregnate_perk = { has_perk_trigger = { PERK = fertility_control_perk } }
				flag:weaken_trait_perk = { has_perk_trigger = { PERK = biomancy_mage_perk } }
				flag:criple_trait_perk = { has_perk_trigger = { PERK = weaken_trait_perk } }
				flag:sculpter_of_flesh_perk = { AND = { has_perk_trigger = { PERK = perfect_trait_perk } has_perk_trigger = { PERK = impregnate_perk } has_perk_trigger = { PERK = criple_trait_perk } } }
				flag:architect_of_bloodlines_perk = { has_perk_trigger = { PERK = sculpter_of_flesh_perk } }
				flag:domination_mage_perk = { has_perk_trigger = { PERK = mage_perk } }
				flag:entrance_perk = { always = yes }
				flag:incite_lust_perk = { always = yes }
				flag:incite_obedience_perk = { always = yes }
				flag:dominate_perk = { always = yes }
				flag:beguiling_aura_perk = { always = yes }
				flag:friendship_perk = { always = yes }
				flag:enchanting_aura_perk = { always = yes }
				flag:master_of_puppets_perk = { always = yes }
				fallback = { always = no }
			}
		}
	}

	effect = {
		switch = {
			trigger = scope:perk
			flag:mage_perk = { add_perk_from_school_effect = { SCHOOL = none PERK = mage_perk } }
			flag:time_mage_perk = { add_perk_from_school_effect = { SCHOOL = time PERK = time_mage_perk } }
			flag:glimpse_the_future_perk = { add_perk_from_school_effect = { SCHOOL = time PERK = glimpse_the_future_perk } }
			flag:financial_times_perk = { add_perk_from_school_effect = { SCHOOL = time PERK = financial_times_perk } }
			flag:celerity_perk = { add_perk_from_school_effect = { SCHOOL = time PERK = celerity_perk } }
			flag:mass_celerity_perk = { add_perk_from_school_effect = { SCHOOL = time PERK = mass_celerity_perk } }
			flag:slowness_perk = { add_perk_from_school_effect = { SCHOOL = time PERK = slowness_perk } }
			flag:mass_slowness_perk = { add_perk_from_school_effect = { SCHOOL = time PERK = mass_slowness_perk } }
			flag:temporal_manipulation_perk = { add_perk_from_school_effect = { SCHOOL = time PERK = temporal_manipulation_perk } }
			flag:master_of_time_perk = { add_perk_from_school_effect = { SCHOOL = time PERK = master_of_time_perk } }
			flag:life_mage_perk = { add_perk_from_school_effect = { SCHOOL = life PERK = life_mage_perk } }
			flag:inward_reflection_perk = { add_perk_from_school_effect = { SCHOOL = life PERK = inward_reflection_perk } }
			flag:inward_perfection_perk = { add_perk_from_school_effect = { SCHOOL = life PERK = inward_perfection_perk } }
			flag:heal_perk = { add_perk_from_school_effect = { SCHOOL = life PERK = heal_perk } }
			flag:greater_heal_perk = { add_perk_from_school_effect = { SCHOOL = life PERK = greater_heal_perk } }
			flag:battlefield_life_mage_perk = { add_perk_from_school_effect = { SCHOOL = life PERK = battlefield_life_mage_perk } }
			flag:greater_battlefield_life_mage_perk = { add_perk_from_school_effect = { SCHOOL = life PERK = greater_battlefield_life_mage_perk } }
			flag:purity_of_body_perk = { add_perk_from_school_effect = { SCHOOL = life PERK = purity_of_body_perk } }
			flag:avatar_of_life_perk = { add_perk_from_school_effect = { SCHOOL = life PERK = avatar_of_life_perk } }
			flag:elemental_mage_perk = { add_perk_from_school_effect = { SCHOOL = elomancy PERK = elemental_mage_perk } }
			flag:flame_aura_perk = { add_perk_from_school_effect = { SCHOOL = elomancy PERK = flame_aura_perk } }
			flag:flaming_weapons_perk = { add_perk_from_school_effect = { SCHOOL = elomancy PERK = flaming_weapons_perk } }
			flag:living_earthworks_perk = { add_perk_from_school_effect = { SCHOOL = elomancy PERK = living_earthworks_perk } }
			flag:golem_creation_perk = { add_perk_from_school_effect = { SCHOOL = elomancy PERK = golem_creation_perk } }
			flag:control_water_perk = { add_perk_from_school_effect = { SCHOOL = elomancy PERK = control_water_perk } }
			flag:drought_perk = { add_perk_from_school_effect = { SCHOOL = elomancy PERK = drought_perk } }
			flag:elemental_warrior_perk = { add_perk_from_school_effect = { SCHOOL = elomancy PERK = elemental_warrior_perk } }
			flag:lord_of_the_elements_perk = { add_perk_from_school_effect = { SCHOOL = elomancy PERK = lord_of_the_elements_perk } }
			flag:death_mage_perk = { add_perk_from_school_effect = { SCHOOL = necromancy PERK = death_mage_perk } }
			flag:inflict_illness_perk = { add_perk_from_school_effect = { SCHOOL = necromancy PERK = inflict_illness_perk } }
			flag:plague_lord_perk = { add_perk_from_school_effect = { SCHOOL = necromancy PERK = plague_lord_perk } }
			flag:aura_of_death_perk = { add_perk_from_school_effect = { SCHOOL = necromancy PERK = aura_of_death_perk } }
			flag:necromancy_perk = { add_perk_from_school_effect = { SCHOOL = necromancy PERK = necromancy_perk } }
			flag:drain_life_perk = { add_perk_from_school_effect = { SCHOOL = necromancy PERK = drain_life_perk } }
			flag:death_stare_perk = { add_perk_from_school_effect = { SCHOOL = necromancy PERK = death_stare_perk } }
			flag:blight_perk = { add_perk_from_school_effect = { SCHOOL = necromancy PERK = blight_perk } }
			flag:deacon_of_death_perk = { add_perk_from_school_effect = { SCHOOL = necromancy PERK = deacon_of_death_perk } }
			flag:biomancy_mage_perk = { add_perk_from_school_effect = { SCHOOL = biomancy PERK = biomancy_mage_perk } }
			flag:improve_trait_perk = { add_perk_from_school_effect = { SCHOOL = biomancy PERK = improve_trait_perk } }
			flag:perfect_trait_perk = { add_perk_from_school_effect = { SCHOOL = biomancy PERK = perfect_trait_perk } }
			flag:fertility_control_perk = { add_perk_from_school_effect = { SCHOOL = biomancy PERK = fertility_control_perk } }
			flag:impregnate_perk = { add_perk_from_school_effect = { SCHOOL = biomancy PERK = impregnate_perk } }
			flag:weaken_trait_perk = { add_perk_from_school_effect = { SCHOOL = biomancy PERK = weaken_trait_perk } }
			flag:criple_trait_perk = { add_perk_from_school_effect = { SCHOOL = biomancy PERK = criple_trait_perk } }
			flag:sculpter_of_flesh_perk = { add_perk_from_school_effect = { SCHOOL = biomancy PERK = sculpter_of_flesh_perk } }
			flag:architect_of_bloodlines_perk = { add_perk_from_school_effect = { SCHOOL = biomancy PERK = architect_of_bloodlines_perk } }
			flag:domination_mage_perk = { add_perk_from_school_effect = { SCHOOL = mensomancy PERK = domination_mage_perk } }
			flag:entrance_perk = { add_perk_from_school_effect = { SCHOOL = mensomancy PERK = entrance_perk } }
			flag:incite_lust_perk = { add_perk_from_school_effect = { SCHOOL = mensomancy PERK = incite_lust_perk } }
			flag:incite_obedience_perk = { add_perk_from_school_effect = { SCHOOL = mensomancy PERK = incite_obedience_perk } }
			flag:dominate_perk = { add_perk_from_school_effect = { SCHOOL = mensomancy PERK = dominate_perk } }
			flag:beguiling_aura_perk = { add_perk_from_school_effect = { SCHOOL = mensomancy PERK = beguiling_aura_perk } }
			flag:friendship_perk = { add_perk_from_school_effect = { SCHOOL = mensomancy PERK = friendship_perk } }
			flag:enchanting_aura_perk = { add_perk_from_school_effect = { SCHOOL = mensomancy PERK = enchanting_aura_perk } }
			flag:master_of_puppets_perk = { add_perk_from_school_effect = { SCHOOL = mensomancy PERK = master_of_puppets_perk } }
		}
	}
}
