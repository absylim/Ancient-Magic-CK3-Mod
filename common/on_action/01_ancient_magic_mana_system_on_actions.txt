yearly_global_pulse = {
	on_actions = {
		yearly_mana_pulse
	}
}

yearly_mana_pulse = {
	effect = {
		every_living_character = {
			limit = { is_magus_trigger = yes }
			set_variable = {
				name = mana_gen_months_left
				value = 12
			}
			trigger_event = { on_action = monthly_mana_gen }
			#set_variable = {
			#	name = mana_gen_days_left
			#	value = 365
			#}
			#trigger_event = { on_action = daily_mana_gen }
		}
	}
}

set_up_remaining_mana_gen_for_year = {
	effect = {
		set_variable = {
			name = mana_gen_months_left
			value = 12
			subtract = current_month
		}
		trigger_event = { on_action = monthly_mana_gen }
		#set_variable = {
		#	name = mana_gen_days_left
		#	value = 365
		#	subtract = current_day_in_year
		#}
		#trigger_event = { on_action = daily_mana_gen }
	}
}

monthly_mana_gen = {
	trigger = {
		has_variable = mana_gen_months_left
		var:mana_gen_months_left > 0
	}

	on_actions = {
		give_monthly_mana
		delay = { days = days_total_in_month }
		monthly_mana_gen
	}

	effect = {
		change_variable = {
			name = mana_gen_months_left
			subtract = 1
		}
	}
}

give_monthly_mana = {
	effect = {
		# the effect clamps to 0 < mana < max_mana
		change_mana = { VALUE = var:mana_gen }

		if = { #Infinite mana trait
			limit = { has_trait = infinite_mana }
			set_variable = {
				name = max_mana
				value = 999999
			}
			set_variable = {
				name = mana
				value = var:max_mana
			}
		}
	}
}

daily_mana_gen = {
	trigger = {
		has_variable = mana_gen_days_left
		var:mana_gen_days_left > 0
	}

	on_actions = {
		give_daily_mana
		delay = { days = 1 }
		daily_mana_gen
	}

	effect = {
		change_variable = {
			name = mana_gen_days_left
			subtract = 1
		}
	}
}

give_daily_mana = {
	effect = {
		# the effect clamps to 0 < mana < max_mana
		save_temporary_scope_value_as = {
			name = daily_gen
			value = {
				value = var:mana_gen
				multiply = 12
				divide = 365
			}
		}
		change_mana = { VALUE = scope:daily_gen }

		if = { #Infinite mana trait
			limit = { has_trait = infinite_mana }
			set_variable = {
				name = max_mana
				value = 999999
			}
			set_variable = {
				name = mana
				value = var:max_mana
			}
		}
	}
}

on_reset_mana_system = {
	trigger = { is_magus_trigger = yes }

	events = {
		ancient_magic_aura_update_events.001
	}

	effect = {
		set_variable = {
			name = max_mana
			value = ancient_magic_max_mana
		}
		set_variable = {
			name = mana_gen
			value = ancient_magic_mana_gen
		}
		set_variable = {
			name = mana
			value = {
				value = var:mana
				max = var:max_mana
				min = 0
			}
		}
	}
}
