reset_mana_system = {
	on_actions = { ancient_magic_reset_mana_system }
}

ancient_magic_reset_mana_system = {
	events = {
		ancient_magic_aura_update_events.001
	}

	effect = {
		change_variable = {
			name = mana_gen
			add = ancient_magic_mana_gen
		}
		change_variable = {
			name = max_mana
			add = ancient_magic_max_mana
		}
	}
}

quarterly_playable_pulse = {
	trigger = {
		has_trait = mage
	}

	on_actions = {
		monthly_mage_xp
		delay = { months = 1 }
		monthly_mage_xp
		delay = { months = 2 }
		monthly_mage_xp
	}
}

# gain xp passively for channelling spells
monthly_mage_xp = {
	effect = {
		change_mage_xp = { VALUE = ancient_magic_mana_drain_auras.abs }
	}
}

death_stare_action = {
	effect = {
		scope:spell_target = {
			death = {
				killer = scope:spell_caster
				death_reason = death_stare
			}
		}
	}
}

#Check immortals to see if they've been initialized
random_yearly_everyone_pulse = {
	on_actions = {
		check_lifetime_flags_for_immortal
		update_immortal_years_since_master_of_time_spell
	}
}

update_immortal_years_since_master_of_time_spell= {
	trigger = {
		has_trait = immortal
	}

	effect = {
		limit = {
			has_variable_list = master_of_time_spell_targets
			is_target_in_variable_list = { name = master_of_time_spell_targets target = prev }
		}
		add_immortal_years_since_master_of_time_spell = yes
	}
}

check_lifetime_flags_for_immortal = {
	trigger = {
		is_immortal = yes
		#is_ai = no # Because they aren't real people :(
		NOT = { has_game_rule = none_immortal_lifetime_events_reset }
		immortal_has_lifetime_flags = yes
	}
	effect = {
		add_immortal_years_since_lifetime_reset = yes
		if = {
			limit = {
				has_game_rule = 1_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 1
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 10_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 10
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 25_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 25
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 50_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 50
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 75_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 75
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 100_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 100
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
	}
}
