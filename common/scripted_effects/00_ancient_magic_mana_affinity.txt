#Author: Donekulda

#Script that is mostly called on childs birth
give_base_mana_affinity = {
	set_local_variable  = {
		name = temp_base_mana_affinity_value
		value = 0
	}
	
	if = { #if player and game rule isnt for random give mana potential based on rules
		limit = {
			is_ai = no
			NOT = { has_game_rule = PC_magic_level_0 }
		}
		add_trait = magic_potential_2
		#Mundane is Tier 0
		if = { # Tier 1 (sub-magical)
			limit = {
				has_game_rule = PC_magic_level_1
			}
			random_list = { # Affinity is given in range of Tier 1
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 5 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 6 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 7 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 8 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 9 } }
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 10 } }
			}
		}
		else_if = { # Tier 2 (magical)
			limit = {
				has_game_rule = PC_magic_level_2
			}
			random_list = { # Affinity is given in range of Tier 2
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 10 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 11 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 12 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 13 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 14 } }
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 15 } }
			}
		}
		else_if = { # Tier 3 (Loved by mana)
			limit = {
				has_game_rule = PC_magic_level_2
			}
			random_list = { # Affinity is given in range of Tier 3
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 15 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 16 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 17 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 18 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 19 } }
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 20 } }
			}
		}
		else_if = { # Tier 4 (Demigod)
			limit = {
				has_game_rule = PC_magic_level_2
			}
			random_list = { # Affinity is given in range of Tier 4
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 20 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 21 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 22 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 23 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 24 } }
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 25 } }
			}
		}
		else_if = { # Tier 5 (God)
			limit = {
				has_game_rule = PC_magic_level_2
			}
			random_list = { # Affinity is given in range of Tier 5
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 25 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 26 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 27 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 28 } }
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 29 } }
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 30 } }
			}
		}
		
	}
	else_if = { #Check if already character doesnt have base mana affinity to save resources
		limit = {
			NOT = { has_variable = base_mana_affinity }
		}
		set_local_variable  = {
			name = temp_mother_base_mana_affinity_value
			value = 0
		}
		set_local_variable  = {
			name = temp_father_base_mana_affinity_value
			value = 0
		}
		if = { #Checks if mana affinity should be inherited
			limit = {
				OR = {
					AND = {
						exists = mother
						mother = { has_variable = base_mana_affinity }
					}
					AND = {
						exists = real_father
						real_father = { has_variable = base_mana_affinity }
					}
				}
			}
			
			mother = {
				if = {
					limit = {
						has_variable = base_mana_affinity
					}
					change_local_variable = { 
						name = temp_mother_base_mana_affinity_value 
						add = base_mana_affinity
							
						if = {
							limit = {
								is_magus_trigger = yes
							}
							add = {
								value = mage_level
								divide = {
									value = mana_affinity
									multiply = 5
								}
								subtract = { # To make it harder to increase on higher levels using mage level and to lower it if the mage level is low
									value = mana_affinity
									divide = 5 # use of 5 because the tiers are per five and because mundanes are first 5
								}
							}
						}
						else = { #if one isnt practicing magic their mana affinity could lower, this is mainly so for those of higher levels
							subtract = {
								value = mana_affinity
								divide = 5
							}
						}
					}
				}
			}
			
			real_father = {
				if = {
					limit = {
						has_variable = base_mana_affinity
					}
					change_local_variable = { 
						name = temp_father_base_mana_affinity_value 
						add = base_mana_affinity
							
						if = {
							limit = {
								is_magus_trigger = yes
							}
							add = {
								value = mage_level
								divide = {
									value = mana_affinity
									multiply = 5
									multiply = 2 # The factor of father has to be lower as the mother is carrier of the child
									
								}
								subtract = { # To make it harder to increase on higher levels using mage level and to lower it if the mage level is low
									value = mana_affinity
									divide = {
										value = 5 # use of 5 because the tiers are per five and because mundanes are first 5
										multiply = 2 # as its father so should the effect factor of lowering be lower 
									}
								}
							}
						}
						else = { #if one isnt practicing magic their childs mana affinity could lower, this is mainly so for those of higher levels
							subtract = {
								value = mana_affinity
								devide = 5 # use of 5 because the tiers are per five and because mundanes are first 5
							}
						}
					}
				}
			}
			if = {
				limit = {
					temp_mother_base_mana_affinity_value > 0
					temp_father_base_mana_affinity_value > 0
				}
				#Duel to determine from whom should the affinity be inherited from	
				duel = {
					value = temp_mother_base_mana_affinity_value #mothers mana affinity
					
					50 = { #Mothers affinity wins
						compare_modifier = {
							value = scope:duel_value
						}
						
						change_local_variable = { 
							name = temp_base_mana_affinity_value 
							add = scope:duel_value
						}
						
						max = 99
						min = 1
					}
					
					50 = { #Fathers affinity wins
						compare_modifier = {
							value = temp_father_base_mana_affinity_value
						}
						
						change_local_variable = { 
							name = temp_base_mana_affinity_value 
							add = temp_father_base_mana_affinity_value
						}
					
						max = 99
						min = 1
					}
				}
			}
			else_if = {
				limit = {
					temp_mother_base_mana_affinity_value > 0
				}
				change_local_variable = { 
					name = temp_base_mana_affinity_value 
					add = temp_mother_base_mana_affinity_value
				}
			}
			else_if = {
				limit = {
					temp_father_base_mana_affinity_value > 0
				}
				change_local_variable = { 
					name = temp_base_mana_affinity_value 
					add = temp_father_base_mana_affinity_value
				}
			}
		}
		else = {
			random_list = { # Affinity given at random if noparents with magical affinity
				10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 0 } } # 0 affinity
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 1 } } # 1
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 2 } } # 2
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 3 } } # 3
				20 = { change_local_variable = { name = temp_base_mana_affinity_value add = 4 } } # 4
				9 = { change_local_variable = { name = temp_base_mana_affinity_value add = 5 } } # 5
				1 = { change_local_variable = { name = temp_base_mana_affinity_value add = 6 } }
			}
		}
		
		random_list = { #Gives small chance of increasing/decreasing mana affinity
			80 = {} #nothing happenes
			10 = { change_local_variable = { name = temp_base_mana_affinity_value add = 1 } } # Increases by 1
			10 = { change_local_variable = { name = temp_base_mana_affinity_value subtract = 1 } } # Decreases by 1
		}
	}
		
	# Checks and adds mana affinity bonus if born on ley line or focal point
	if = {
		limit = {
			is_located_on_ley_line = yes
			temp_base_mana_affinity_value < 10 #So that its not easy after some tier to increase it with ley line
		}
		random_list = {
			75 = {} #Nothing happens
			15 = { change_local_variable = { name = temp_base_mana_affinity_value add = 1 } }
			9 = { change_local_variable = { name = temp_base_mana_affinity_value add = 2 } }
			1 = { change_local_variable = { name = temp_base_mana_affinity_value add = 3 } }
		}
	}
	else_if = {
		limit = {
			is_located_on_focal_point = yes
			temp_base_mana_affinity_value < 15 #So that its not easy after some tier to increase it with focul points
		}
		random_list = {
			50 = {} #Nothing happens
			30 = { change_local_variable = { name = temp_base_mana_affinity_value add = 1 } }
			15 = { change_local_variable = { name = temp_base_mana_affinity_value add = 2 } }
			5 = { change_local_variable = { name = temp_base_mana_affinity_value add = 3 } }
		}
	}
	
	change_local_variable = {
		name = temp_base_mana_affinity_value 
		add = base_mana_affinity_bonus
	}
			
	set_variable = {
		name = base_mana_affinity
		value = temp_base_mana_affinity_value
		
		min = 0
		max = 30
	}
}